version: '3' # 保持群晖兼容的版本号

services:
  # 服务 1: Streamlit 前端
  web:
    build: .
    container_name: yurara-web
    restart: always
    ports:
      - "8501:8501"
    volumes:
      # ⚠️ 关键：确保 secrets.toml 里的 DATABASE_URL 是 Supabase 的地址
      - ./.streamlit/secrets.toml:/app/.streamlit/secrets.toml:ro
    # depends_on: - db  <-- 删除这行，因为不再依赖本地库
    networks:
      - yurara-net

  # 服务 2: Discord Bot
  bot:
    build: .
    container_name: yurara-bot
    restart: always
    command: python bot.py
    volumes:
      # Bot 同时也挂载了 secrets，database.py 会优先尝试读取它
      - ./.streamlit/secrets.toml:/app/.streamlit/secrets.toml:ro
      # 如果你的 bot 逻辑里有备用的环境变量读取，也可以保留这个
      - ./.env:/app/.env
    # depends_on: - db  <-- 删除这行
    networks:
      - yurara-net

# 删除了 volumes 模块，因为不需要本地数据库存储卷

networks:
  yurara-net:
    driver: bridge