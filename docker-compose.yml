version: '3.8'

services:
  # 服务 1: Streamlit 前端
  web:
    build: .
    container_name: yurara-web
    restart: always
    ports:
      - "8501:8501"  # NAS 访问端口 : 容器端口
    volumes:
      - ./.streamlit/secrets.toml:/app/.streamlit/secrets.toml:ro # 挂载配置文件
      # - ./database.db:/app/database.db # 如果用 SQLite 请取消注释这行
    depends_on:
      - db
    networks:
      - yurara-net

  # 服务 2: Discord Bot (复用同一个镜像，但运行不同的命令)
  bot:
    build: .
    container_name: yurara-bot
    restart: always
    command: python bot.py
    volumes:
      - ./.streamlit/secrets.toml:/app/.streamlit/secrets.toml:ro
      - ./.env:/app/.env # 挂载 Bot 的环境变量
    depends_on:
      - db
    networks:
      - yurara-net

  # 服务 3: PostgreSQL 数据库 (推荐在 NAS 上使用 Postgres 而不是 SQLite)
  db:
    image: postgres:15-alpine
    container_name: yurara-db
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mysecretpassword # 务必修改这个密码
      POSTGRES_DB: yurara_studio
    volumes:
      - postgres_data:/var/lib/postgresql/data # 数据持久化
    ports:
      - "5432:5432" # 仅用于调试，生产环境可不映射
    networks:
      - yurara-net

volumes:
  postgres_data:

networks:
  yurara-net:
    driver: bridge